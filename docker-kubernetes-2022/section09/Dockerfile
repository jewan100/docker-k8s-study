# ------------------------------------------------------------------
# 1단계 스테이지: 빌드 전용 컨테이너
# - 멀티 스테이지 빌드에서 "build"라는 이름을 가진 첫 번째 스테이지 정의
# - Node.js 런타임과 빌드 도구만 사용하는 일회용 환경
# - 여기서만 npm install, npm run build를 수행하고 결과물(정적 파일)만 다음 스테이지로 전달함
# ------------------------------------------------------------------
FROM node:14-alpine as build

# 애플리케이션 빌드를 수행할 작업 디렉터리 설정
WORKDIR /app

# 의존성 정의 파일만 먼저 복사해, 캐시를 최대한 활용하기 위함
COPY package.json .

# package.json 기준으로 의존성 설치
# 멀티 스테이지에서만 실행되며, 최종 이미지에는 node_modules가 포함되지 않음
RUN npm install

# 나머지 애플리케이션 소스 코드 전체 복사
COPY . .

# 프론트엔드 정적 파일 빌드
# 보통 /app/build 또는 /app/dist 같은 디렉터리에 빌드 결과 생성됨
RUN npm run build

# ------------------------------------------------------------------
# 2단계 스테이지: 실제 서비스용 Nginx 컨테이너
# - 멀티 스테이지 빌드의 두 번째 스테이지
# - 위 "build" 스테이지에서 만들어진 정적 파일만 가져와서 서빙함
# - Node.js, 빌드 도구, 소스코드는 포함되지 않으므로 이미지 사이즈 최소화됨
# ------------------------------------------------------------------
FROM nginx:stable-alpine

# 멀티 스테이지 빌드의 핵심 부분
# - 이전 스테이지 이름 "build"에서 /app/build 디렉터리만 가져옴
# - 해당 빌드 결과를 Nginx 기본 문서 루트(/usr/share/nginx/html)로 복사
# - 결과적으로 최종 이미지는 "정적 파일 + Nginx"만 포함하게 됨
COPY --from=build /app/build /usr/share/nginx/html

# 컨테이너 외부에 개방할 포트 (Nginx 기본 HTTP 포트)
EXPOSE 80

# Nginx를 포그라운드 모드로 실행하여 컨테이너가 계속 살아 있도록 함
CMD ["nginx", "-g", "daemon off;"]
