# Data Management

- 컨테이너: 기본적으로 휘발성 파일 시스템
  - 컨테이너 삭제 시 내부 데이터 전체 삭제
- DB, 로그, 업로드 파일 등 중요한 데이터: 컨테이너 외부 별도 관리 필요

## Volume

> 도커가 관리하는 영속 데이터 저장소

- 도커가 호스트에 생성, 관리하는 전용 디렉터리
- 컨테이너를 제거해도 볼륨 내 데이터 유지
- 여러 컨테이너에서 동일 볼륨에 대한 공동 액세스 가능
- 호스트 파일 시스템 어딘가에 디렉터리로 존재하지만, 일반적으로 이름(name)으로 관리하는 저장소

### 익명 볼륨 (Anonymous Volume)

> 이름을 지정하지 않고 경로만 지정했을 때 자동으로 생성되는 볼륨  
> 예: `docker run -v /var/lib/app/data myapp`

- 도커가 내부적으로 임의의 이름을 붙이기 때문에 식별, 관리가 불편
- 컨테이너를 지워도 볼륨이 남아 dangling volume이 쌓일 수 있는 상태

### 명명 볼륨 (Named Volume)

> 사용자가 이름을 지정해서 사용하는 볼륨  
> 예: `docker run -v app-data:/var/lib/app/data myapp`

- `docker volume ls`에서 이름으로 관리 가능
- 여러 컨테이너에서 같은 이름을 사용해 재사용 가능한 데이터 저장소
- 영구적이며, 편집하거나 직접 볼 필요가 없는 데이터에 적합

## Bind Mount

> 호스트 파일 시스템을 그대로 사용하는 데이터 저장소  
> 예: `docker run -v /home/user/app-data:/var/lib/app/data myapp`

- 호스트의 특정 디렉터리 또는 파일을 컨테이너 내부 경로에 직접 연결하는 방식
- 컨테이너를 삭제해도 데이터는 호스트에 그대로 남음
- 호스트에서 파일을 수정하면 컨테이너에서 즉시 반영되는 양방향 공유 구조
- 개발 환경에서 소스 코드, 설정 파일, 로그 파일 등을 공유할 때 적합

### Volume & Bind Mount 요약

| 항목        | Volume                                  | Bind Mount                         |
| ----------- | --------------------------------------- | ---------------------------------- |
| 관리 주체   | Docker                                  | 호스트/사용자                      |
| 지정 방식   | 볼륨 이름 + 컨테이너 경로               | 호스트 경로 + 컨테이너 경로        |
| 대표 용도   | DB 데이터, 영구 저장소                  | 소스 코드, 설정 파일, 로그 공유    |
| 이식성      | 호스트 경로에 덜 의존                   | 호스트 디렉터리 구조에 강하게 의존 |
| 관리 난이도 | `docker volume` 명령으로 일괄 관리 가능 | OS/경로 기반 수동 관리 필요        |

---

## `.dockerignore`

> Dockerfile에서 `COPY` / `ADD` 명령으로 빌드 컨텍스트 전체가 복사되지 않도록 제외하는 설정 파일

- 불필요한 파일을 제외해 빌드 속도 최적화, 이미지 크기 감소, 캐시 효율 증가 목적
- Git, 빌드 결과물, IDE 설정, 로그 파일 등은 `.dockerignore`로 제외하는 것이 권장 패턴

## ENV

> Dockerfile에서 컨테이너 실행 시 사용할 환경 변수를 정의하는 명령

- 이미지 빌드 시점에 환경 변수 값을 기록하고, 컨테이너 실행 시 기본값으로 사용되는 설정
- 애플리케이션 설정, Spring Profile, DB 접속 정보(민감 값은 보통 외부에서 주입) 등에 사용

## ARG

> Dockerfile에서 이미지 빌드 시점에만 사용할 변수(빌드 인자)를 정의하는 명령

- 빌드 과정에서만 사용되고, 컨테이너 실행 시점에는 환경 변수로 직접 노출되지 않는 값

### ENV & ARG 요약

| 항목        | ENV                                       | ARG                                      |
| ----------- | ----------------------------------------- | ---------------------------------------- |
| 사용 시점   | 컨테이너 실행 시점(런타임)                | 이미지 빌드 시점(빌드 타임)              |
| 정의 위치   | `ENV KEY=VALUE`                           | `ARG KEY=DEFAULT`                        |
| 조회 가능성 | 컨테이너 내부 환경 변수로 조회 가능       | 빌드 중에만 사용, 컨테이너에서 조회 불가 |
| 덮어쓰기    | `docker run -e`, compose, K8s 등에서 변경 | `docker build --build-arg`로 변경        |
| 대표 용도   | 애플리케이션 설정, 프로파일, 일반 환경 값 | JAR 경로, 빌드 옵션, 버전 등 빌드용 값   |

### 민감 정보(Secrets) 주의 사항

- Dockerfile의 `ENV`, `ARG`, `RUN` 등에 비밀번호, 토큰, 개인 키를 직접 하드코딩할 경우 값이 이미지 레이어에 포함됨
- `docker history <이미지> --no-trunc` 명령으로 빌드 명령 이력을 조회할 때 민감 값이 그대로 노출될 수 있음
- 자격 증명, 개인 키 등 민감 정보는 이미지 안이 아닌 외부에서 주입하는 방식 사용 권장됨
  - `docker run -e KEY=...` 환경 변수 주입 방식 사용
  - docker-compose / Kubernetes Secret 등 외부 Secret 관리 기능 사용
  - 비밀 값이 들어있는 파일을 Bind Mount로 마운트하는 방식 활용
- 별도 Secrets 파일을 사용하는 경우, 해당 파일은 Git 등 소스 컨트롤에 커밋하지 않고 `.gitignore`, `.dockerignore`에 함께 등록
